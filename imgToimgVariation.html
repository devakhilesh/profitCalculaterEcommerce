<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Image Variations — Full View</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#08101a; --muted:#93a3b8; --accent:#60a5fa;
      --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;
      background: linear-gradient(180deg,#031021 0%,#071427 100%); color:#e6eef8;
      display:flex; align-items:flex-start; justify-content:center; padding:36px;
    }
    .card{width:1100px; max-width:95%; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
      border-radius:12px; padding:20px; box-shadow:0 10px 40px rgba(2,6,23,0.7);}
    h1{margin:0;font-size:20px}
    p.lead{margin:6px 0 18px;color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:380px 1fr; gap:16px; align-items:start;}
    .panel{background:var(--panel); border-radius:10px; padding:12px; border:1px solid var(--glass);}
    label{display:block;font-size:12px;color:var(--muted); margin-bottom:6px}
    input[type=text], input[type=file]{width:100%; padding:9px;border-radius:8px;border:1px solid rgba(255,255,255,0.03); background:transparent;color:inherit}
    .row{display:flex; gap:8px; margin-top:10px}
    button{background:var(--accent); border:none; padding:9px 12px; border-radius:8px; color:#032029; font-weight:700; cursor:pointer}
    button.ghost{background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.04)}
    .preview-img{width:100%; height:240px; object-fit:cover; border-radius:8px; border:1px solid rgba(255,255,255,0.03)}
    .mini{font-size:12px;color:var(--muted)}
    .results-grid{display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px}
    .result-card{background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00)); padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03)}
    .result-card img{width:100%; height:220px; object-fit:cover; border-radius:6px; cursor:pointer}
    pre.debug{background:#020617; padding:10px; border-radius:8px; max-height:280px; overflow:auto; color:#9fb3d9; font-size:12px}
    .meta{margin-top:10px; font-size:13px; color:var(--muted)}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} .preview-img{height:180px} .result-card img{height:160px} }

    /* Lightbox styles */
    .lightbox {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(2,6,23,0.85);
      z-index: 9999;
    }
    .lightbox.visible { display:flex; }
    .lightbox-content {
      max-width: 92%;
      max-height: 92%;
      position: relative;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
    }
    .lightbox img {
      max-width: 100%;
      max-height: 100%;
      border-radius: 8px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.7);
      background: #000;
    }
    .lb-close, .lb-prev, .lb-next {
      position: absolute;
      top: 12px;
      padding: 8px 10px;
      border-radius: 8px;
      background: rgba(255,255,255,0.06);
      color: #e6eef8;
      border: none;
      cursor: pointer;
      font-weight: 700;
    }
    .lb-close { right: 12px; }
    .lb-prev, .lb-next {
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.04);
      padding: 12px;
      font-size: 18px;
    }
    .lb-prev { left: -60px; }
    .lb-next { right: -60px; }
    @media (max-width:720px){ .lb-prev { left: 8px; } .lb-next { right: 8px; } .lb-prev,.lb-next { display:flex; align-items:center; justify-content:center; }}
  </style>
</head>
<body>
  <div class="card">
    <h1>Image Variations</h1>
    <p class="lead">Upload an image or paste a public image URL. This UI will call <code>/user/imgVariation</code> and show the generated variations — click to view full-size.</p>

    <div class="grid">
      <!-- left: controls + input preview -->
      <div class="panel">
        <label for="file">Upload image (preferred)</label>
        <input id="file" type="file" accept="image/*" />

        <div style="height:10px"></div>

        <label for="url">Or image URL (public)</label>
        <input id="url" type="text" placeholder="https://example.com/my-image.jpg" />

        <div class="row">
          <button id="go">Generate Variations</button>
          <button id="clear" class="ghost" type="button">Clear</button>
        </div>

        <div style="height:12px"></div>

        <div class="meta"><strong>Endpoint:</strong> <span class="mini">http://localhost:3001/user/imgVariation</span></div>
        <div style="height:8px"></div>
        <div class="meta"><strong>Status:</strong> <span id="status" class="mini">idle</span></div>

        <div style="height:12px"></div>
        <label>Input preview</label>
        <img id="inputPreview" class="preview-img" src="" alt="input preview" style="display:none"/>

        <div style="height:8px"></div>
        <div class="mini">Prompt used:</div>
        <div id="promptBox" class="mini" style="background:transparent; margin-top:6px; padding:8px; border-radius:6px; border:1px solid rgba(255,255,255,0.02); color:var(--muted);"></div>
      </div>

      <!-- right: results -->
      <div>
        <div class="panel">
          <div style="display:flex; justify-content:space-between; align-items:center">
            <div><strong>Generated variations</strong> <span class="mini" id="countLabel"></span></div>
            <div><button id="openAll" class="ghost" type="button">Open All</button></div>
          </div>

          <div id="results" class="results-grid" style="margin-top:12px">
            <!-- dynamic result cards -->
          </div>

          <div style="height:12px"></div>

          <div><strong>Raw response / debug</strong></div>
          <pre id="raw" class="debug">no response yet</pre>
        </div>

        <div style="height:12px"></div>

        <div class="panel">
          <div><strong>Notes</strong></div>
          <div class="mini" style="margin-top:8px">
            - If you upload a file this client sends a multipart form with field name <code>imageFile</code> (express-fileupload).<br>
            - Otherwise it sends JSON: <code>{ "image": "https://..." }</code>.<br>
            - This UI expects the backend to return JSON with <code>data.extractedUrls</code> (array) or similar shapes — the UI will also look for any HTTP URLs in the raw response.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox" aria-hidden="true">
    <div class="lightbox-content" role="dialog" aria-modal="true">
      <button class="lb-prev" id="lbPrev" title="Previous (←)">&larr;</button>
      <img id="lbImage" src="" alt="Full view image" />
      <button class="lb-next" id="lbNext" title="Next (→)">&rarr;</button>
      <button class="lb-close" id="lbClose" title="Close (Esc)">✕</button>
    </div>
  </div>

  <script>
    const fileEl = document.getElementById('file');
    const urlEl = document.getElementById('url');
    const goBtn = document.getElementById('go');
    const clearBtn = document.getElementById('clear');
    const inputPreview = document.getElementById('inputPreview');
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    const rawEl = document.getElementById('raw');
    const promptBox = document.getElementById('promptBox');
    const countLabel = document.getElementById('countLabel');
    const openAllBtn = document.getElementById('openAll');

    // Lightbox elements
    const lb = document.getElementById('lightbox');
    const lbImage = document.getElementById('lbImage');
    const lbClose = document.getElementById('lbClose');
    const lbPrev = document.getElementById('lbPrev');
    const lbNext = document.getElementById('lbNext');

    // The same prompt your server uses — keep in sync if you change server prompt
    const PROMPT = "Generate 2 realistic variations of the provided image. Preserve the main subject and composition while introducing natural changes to color tone, lighting, and subtle details. Outputs should be photorealistic and high quality.";

    promptBox.textContent = PROMPT;

    let latestUrls = [];
    let currentIndex = 0;

    fileEl.addEventListener('change', ()=> {
      const f = fileEl.files && fileEl.files[0];
      if(!f){ inputPreview.style.display='none'; inputPreview.src=''; return; }
      inputPreview.src = URL.createObjectURL(f);
      inputPreview.style.display='block';
    });

    urlEl.addEventListener('input', ()=>{
      const v = urlEl.value.trim();
      if(!v && !(fileEl.files && fileEl.files.length)) {
        inputPreview.style.display='none'; inputPreview.src='';
      } else if(v){
        inputPreview.src = v; inputPreview.style.display='block';
      }
    });

    clearBtn.addEventListener('click', ()=> {
      fileEl.value = ''; urlEl.value = ''; inputPreview.style.display='none'; inputPreview.src=''; resultsEl.innerHTML=''; rawEl.textContent='no response yet'; statusEl.textContent='idle'; promptBox.textContent = PROMPT; countLabel.textContent='';
      latestUrls = []; currentIndex = 0;
    });

    openAllBtn.addEventListener('click', ()=> {
      if(!latestUrls.length) return alert('No images to open');
      latestUrls.forEach(u=> window.open(u, '_blank'));
    });

    // smart extraction: tries structured fields then regex fallback
    function extractUrlsFromJson(json){
      try {
        if(!json) return [];
        // common: data.extractedUrls or data.extracted_urls
        if(json.data && Array.isArray(json.data.extractedUrls)) return json.data.extractedUrls;
        if(json.data && Array.isArray(json.data.extracted_urls)) return json.data.extracted_urls;
        // If server returned { data: { extractedUrls: [...] } } use that
        // fallback: find all http(s) in string
        const s = JSON.stringify(json);
        // <-- FIXED REGEX: match http(s) URLs correctly -->
        const rx = /https?:\/\/[^\s"']+/g;
        const matches = s.match(rx) || [];
        const uniq = [...new Set(matches)];
        return uniq;
      } catch(e) { return []; }
    }

    function openLightbox(index) {
      if(!latestUrls.length) return;
      currentIndex = ((index % latestUrls.length) + latestUrls.length) % latestUrls.length;
      lbImage.src = latestUrls[currentIndex];
      lb.classList.add('visible');
      lb.setAttribute('aria-hidden', 'false');
    }
    function closeLightbox() {
      lb.classList.remove('visible');
      lb.setAttribute('aria-hidden', 'true');
      lbImage.src = '';
    }
    function showPrev() {
      if(!latestUrls.length) return;
      currentIndex = (currentIndex - 1 + latestUrls.length) % latestUrls.length;
      lbImage.src = latestUrls[currentIndex];
    }
    function showNext() {
      if(!latestUrls.length) return;
      currentIndex = (currentIndex + 1) % latestUrls.length;
      lbImage.src = latestUrls[currentIndex];
    }

    // keyboard navigation
    document.addEventListener('keydown', (e) => {
      if(lb.classList.contains('visible')) {
        if(e.key === 'Escape') closeLightbox();
        if(e.key === 'ArrowLeft') showPrev();
        if(e.key === 'ArrowRight') showNext();
      }
    });

    lbClose.addEventListener('click', closeLightbox);
    lbPrev.addEventListener('click', showPrev);
    lbNext.addEventListener('click', showNext);
    lb.addEventListener('click', (ev)=> {
      // close when clicking the backdrop (not the image)
      if(ev.target === lb) closeLightbox();
    });

    async function sendRequest(){
      resultsEl.innerHTML = ''; rawEl.textContent = 'waiting for response...'; statusEl.textContent = 'sending';
      const endpoint = 'http://localhost:3001/user/imgVariation';

      try {
        let res, json;
        // if a file is provided, send multipart form
        if(fileEl.files && fileEl.files[0]) {
          const f = fileEl.files[0];
          const fd = new FormData();
          fd.append('imageFile', f, f.name);
          // include any additional options if your backend supports them
          res = await fetch(endpoint, { method:'POST', body: fd });
          json = await res.json();
        } else {
          const u = urlEl.value.trim();
          if(!u) { alert('Please upload a file or provide an image URL'); statusEl.textContent='idle'; return; }
          res = await fetch(endpoint, {
            method:'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ image: u })
          });
          json = await res.json();
        }

        rawEl.textContent = JSON.stringify(json, null, 2);
        statusEl.textContent = (json && json.status) ? 'success' : 'failed';

        // Try well-known paths first, then fallback
        let urls = [];
        if(json && json.data) {
          if(Array.isArray(json.data.extractedUrls)) urls = json.data.extractedUrls;
          else if(Array.isArray(json.data.extracted_urls)) urls = json.data.extracted_urls;
          else if(json.data.extractedUrl && typeof json.data.extractedUrl === 'string') urls = [json.data.extractedUrl];
          else if(json.data && json.data.raw && typeof json.data.raw === 'object') {
            // if your server returned raw inside data.raw
            urls = extractUrlsFromJson(json.data.raw);
          }
        }
        if(!urls.length) {
          // last-chance: search whole JSON
          urls = extractUrlsFromJson(json);
        }

        latestUrls = urls.slice(0, 2); // take up to 2
        countLabel.textContent = latestUrls.length ? `(${latestUrls.length})` : '(0)';

        if(!latestUrls.length) {
          const msg = document.createElement('div'); msg.className='mini'; msg.textContent = 'No variation images found in response.';
          resultsEl.appendChild(msg);
          return;
        }

        // show cards (clickable to open full view)
        latestUrls.forEach((u, i) => {
          const card = document.createElement('div'); card.className = 'result-card';
          const title = document.createElement('div'); title.style.marginBottom = '8px'; title.innerHTML = `<strong>Variation ${i+1}</strong>`;
          const img = document.createElement('img'); img.src = u; img.alt = `variation-${i+1}`;
          img.addEventListener('click', ()=> openLightbox(i));
          const meta = document.createElement('div'); meta.className='mini'; meta.style.marginTop='8px';
          meta.innerHTML = `<a href="${u}" target="_blank" rel="noopener">Open full image</a>`;
          card.appendChild(title); card.appendChild(img); card.appendChild(meta);
          resultsEl.appendChild(card);
        });

        // automatically open lightbox on first image for convenience
        openLightbox(0);

      } catch (err) {
        console.error(err);
        rawEl.textContent = String(err);
        statusEl.textContent = 'error';
      }
    }

    goBtn.addEventListener('click', async (e)=> {
      e.preventDefault();
      await sendRequest();
    });
  </script>
</body>
</html>
